
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zlib å‹ç¼©è§£å‹å·¥å…·</title>
    <!-- å¼•å…¥zlibå¤„ç†åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼ - åŒ¹é…æ¨±èŠ±ç²‰ä¸»é¢˜ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
        }

        body {
            background-color: #FFF0F5; /* æ¨±èŠ±ç²‰èƒŒæ™¯ */
            color: #333;
            padding: 10px;
        }

        /* ä¸»é¢˜é€‰æ‹©åŒºåŸŸ */
        .theme-selector {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .theme-selector label {
            color: #8B008B;
            margin-right: 10px;
            font-size: 14px;
        }

        .theme-selector select {
            padding: 3px 5px;
            border: 1px solid #ddd;
            border-radius: 2px;
            background-color: #fff;
            color: #333;
        }

        /* åŠŸèƒ½åˆ‡æ¢ï¼ˆè§£å‹/å‹ç¼©ï¼‰ */
        .func-switch {
            margin-bottom: 15px;
        }

        .func-switch button {
            padding: 6px 15px;
            background-color: #FFB6C1;
            border: 1px solid #ddd;
            border-radius: 2px;
            color: #333;
            cursor: pointer;
            margin-right: 5px;
        }

        .func-switch button.active {
            background-color: #FF6B8B;
            color: #fff;
            border-color: #FF6B8B;
        }

        /* è·¯å¾„è¾“å…¥åŒºåŸŸ */
        .path-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .path-group label {
            min-width: 80px;
            color: #8B008B;
            font-size: 14px;
        }

        .path-group input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 2px;
            background-color: #fff;
            height: 28px;
        }

        .path-group button {
            padding: 5px 10px;
            background-color: #FFB6C1;
            border: none;
            border-radius: 2px;
            color: #333;
            cursor: pointer;
            margin-left: 5px;
            height: 28px;
        }

        /* Unityç­¾åè¾“å…¥ï¼ˆä»…å‹ç¼©æ˜¾ç¤ºï¼‰ */
        .signature-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            display: none;
        }

        .signature-group label {
            min-width: 80px;
            color: #8B008B;
            font-size: 14px;
        }

        .signature-group input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 2px;
            background-color: #fff;
            height: 28px;
        }

        /* åŠŸèƒ½æŒ‰é’®åŒºåŸŸ */
        .btn-group {
            margin-bottom: 15px;
        }

        .btn-group button {
            padding: 8px 30px;
            background-color: #FF6B8B;
            border: none;
            border-radius: 3px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn-group button:hover {
            background-color: #FF8FA3;
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .log-area {
            border: 1px solid #ddd;
            background-color: #fff;
        }

        .log-area label {
            display: block;
            padding: 5px;
            color: #8B008B;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
        }

        .log-text {
            width: 100%;
            height: 200px;
            border: none;
            padding: 5px;
            resize: none;
            font-size: 13px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- ä¸»é¢˜é€‰æ‹© -->
    <div class="theme-selector">
        <label for="theme-select">é€‰æ‹©ä¸»é¢˜:</label>
        <select id="theme-select">
            <option value="æ¨±èŠ±ç²‰" selected>æ¨±èŠ±ç²‰</option>
        </select>
    </div>

    <!-- åŠŸèƒ½åˆ‡æ¢ï¼ˆè§£å‹/å‹ç¼©ï¼‰ -->
    <div class="func-switch">
        <button id="btn-decompress" class="active">è§£å‹</button>
        <button id="btn-compress">å‹ç¼©</button>
    </div>

    <!-- è¾“å…¥è·¯å¾„ -->
    <div class="path-group">
        <label>è¾“å…¥è·¯å¾„:</label>
        <input type="text" id="input-path" placeholder="è¯·é€‰æ‹©æ–‡ä»¶ï¼ˆå•æ¬¡ï¼‰æˆ–æ–‡ä»¶å¤¹ï¼ˆæ‰¹é‡ï¼‰è·¯å¾„">
        <button id="btn-browse-file">æµè§ˆæ–‡ä»¶</button>
        <button id="btn-browse-folder">æµè§ˆæ–‡ä»¶å¤¹</button>
    </div>

    <!-- Unityç­¾åï¼ˆä»…å‹ç¼©æ˜¾ç¤ºï¼‰ -->
    <div class="signature-group" id="signature-group">
        <label>Unityç­¾å:</label>
        <input type="text" id="unity-signature" value="subway_bundles" placeholder="è¾“å…¥Unityç­¾å">
    </div>

    <!-- è¾“å‡ºè·¯å¾„ -->
    <div class="path-group">
        <label>è¾“å‡ºè·¯å¾„:</label>
        <input type="text" id="output-path" placeholder="è¯·é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„">
        <button id="btn-browse-output">æµè§ˆ</button>
    </div>

    <!-- åŠŸèƒ½æŒ‰é’® -->
    <div class="btn-group">
        <button id="btn-single">å•æ¬¡è§£å‹</button>
        <button id="btn-batch">æ‰¹é‡è§£å‹</button>
        <button id="btn-clear">æ¸…é™¤</button>
    </div>

    <!-- æ—¥å¿—åŒºåŸŸ -->
    <div class="log-area">
        <label>æ“ä½œæ—¥å¿—:</label>
        <textarea class="log-text" id="log-text" readonly></textarea>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentFunc = 'decompress'; // å½“å‰åŠŸèƒ½ï¼šdecompress(è§£å‹)/compress(å‹ç¼©)
        let selectedFiles = [];         // é€‰ä¸­çš„æ–‡ä»¶åˆ—è¡¨
        let inputPath = '';             // è¾“å…¥è·¯å¾„ï¼ˆæ–‡ä»¶/æ–‡ä»¶å¤¹ï¼‰
        let outputPath = '';            // è¾“å‡ºè·¯å¾„ï¼ˆæ–‡ä»¶å¤¹åç§°ï¼‰
        let inputType = '';             // è¾“å…¥ç±»å‹ï¼šfile(å•ä¸ªæ–‡ä»¶)/folder(æ–‡ä»¶å¤¹)
        let selectedDirHandle = null;   // é€‰ä¸­çš„è¾“å‡ºæ–‡ä»¶å¤¹å¥æŸ„ï¼ˆFileSystem Access APIï¼‰
        let isFileSystemSupported = false; // æ˜¯å¦æ”¯æŒFileSystem Access API

        // DOMå…ƒç´ 
        const themeSelect = document.getElementById('theme-select');
        const btnDecompress = document.getElementById('btn-decompress');
        const btnCompress = document.getElementById('btn-compress');
        const inputPathInput = document.getElementById('input-path');
        const btnBrowseFile = document.getElementById('btn-browse-file');
        const btnBrowseFolder = document.getElementById('btn-browse-folder');
        const signatureGroup = document.getElementById('signature-group');
        const unitySignatureInput = document.getElementById('unity-signature');
        const outputPathInput = document.getElementById('output-path');
        const btnBrowseOutput = document.getElementById('btn-browse-output');
        const btnSingle = document.getElementById('btn-single');
        const btnBatch = document.getElementById('btn-batch');
        const btnClear = document.getElementById('btn-clear');
        const logText = document.getElementById('log-text');

        // åˆå§‹åŒ–
        function init() {
            // æ£€æµ‹æ˜¯å¦æ”¯æŒFileSystem Access API
            isFileSystemSupported = 'showDirectoryPicker' in window;
            setupEventListeners();
            log(`Zlibå‹ç¼©è§£å‹å·¥å…·å·²åˆå§‹åŒ–${isFileSystemSupported ? 'ï¼ˆæ”¯æŒæ–‡ä»¶å¤¹ç›´æ¥å†™å…¥ï¼‰' : 'ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹å†™å…¥ï¼Œå°†ä½¿ç”¨ä¸‹è½½æ–¹å¼ï¼‰'}`);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // åŠŸèƒ½åˆ‡æ¢ï¼ˆè§£å‹/å‹ç¼©ï¼‰
            btnDecompress.addEventListener('click', () => switchFunc('decompress'));
            btnCompress.addEventListener('click', () => switchFunc('compress'));

            // æµè§ˆæ–‡ä»¶ï¼ˆå•æ¬¡å¤„ç†ç”¨ï¼‰
            btnBrowseFile.addEventListener('click', browseFile);
            // æµè§ˆæ–‡ä»¶å¤¹ï¼ˆæ‰¹é‡å¤„ç†ç”¨ï¼‰
            btnBrowseFolder.addEventListener('click', browseFolder);
            // æµè§ˆè¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆæ–°å¢ï¼šæ”¯æŒçœŸæ­£é€‰æ‹©æ–‡ä»¶å¤¹ï¼‰
            btnBrowseOutput.addEventListener('click', browseOutputFolder);

            // å•æ¬¡å¤„ç†ï¼ˆä»…å¤„ç†å•ä¸ªæ–‡ä»¶ï¼‰
            btnSingle.addEventListener('click', handleSingle);
            // æ‰¹é‡å¤„ç†ï¼ˆä»…å¤„ç†æ–‡ä»¶å¤¹å†…æ–‡ä»¶ï¼‰
            btnBatch.addEventListener('click', handleBatch);
            // æ¸…é™¤
            btnClear.addEventListener('click', clearAll);
        }

        // åˆ‡æ¢åŠŸèƒ½ï¼ˆè§£å‹/å‹ç¼©ï¼‰
        function switchFunc(func) {
            currentFunc = func;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            btnDecompress.classList.toggle('active', func === 'decompress');
            btnCompress.classList.toggle('active', func === 'compress');
            
            // æ˜¾ç¤º/éšè—Unityç­¾åè¾“å…¥
            signatureGroup.style.display = func === 'compress' ? 'flex' : 'none';
            
            // æ›´æ–°æŒ‰é’®æ–‡å­—
            btnSingle.textContent = func === 'decompress' ? 'å•æ¬¡è§£å‹' : 'å•æ¬¡å‹ç¼©';
            btnBatch.textContent = func === 'decompress' ? 'æ‰¹é‡è§£å‹' : 'æ‰¹é‡å‹ç¼©';
            
            log(`åˆ‡æ¢åˆ°${func === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}æ¨¡å¼`);
        }

        // æµè§ˆå•ä¸ªæ–‡ä»¶ï¼ˆä»…ç”¨äºå•æ¬¡å¤„ç†ï¼‰
        function browseFile() {
            // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = false; // å¼ºåˆ¶å•æ¬¡é€‰ä¸€ä¸ªæ–‡ä»¶
            
            // è¿‡æ»¤æ–‡ä»¶ç±»å‹ï¼ˆè§£å‹/å‹ç¼©ä¸åŒï¼‰
            if (currentFunc === 'decompress') {
                fileInput.accept = '.bundle,.asset,.zlib,.gz';
            }
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    selectedFiles = [file]; // ä»…å­˜å•ä¸ªæ–‡ä»¶
                    inputPath = file.name;
                    inputType = 'file'; // æ ‡è®°è¾“å…¥ç±»å‹ä¸ºå•ä¸ªæ–‡ä»¶
                    inputPathInput.value = file.name;
                    log(`å·²é€‰æ‹©å•ä¸ªæ–‡ä»¶: ${file.name}`);
                }
            });
            
            fileInput.click();
        }

        // æµè§ˆæ–‡ä»¶å¤¹ï¼ˆä»…ç”¨äºæ‰¹é‡å¤„ç†ï¼‰
        function browseFolder() {
            // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥æ¡†ï¼Œå¼€å¯æ–‡ä»¶å¤¹é€‰æ‹©
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.webkitdirectory = true; // å…³é”®ï¼šå¯ç”¨æ–‡ä»¶å¤¹é€‰æ‹©ï¼ˆwebkitå†…æ ¸ï¼‰
            fileInput.dir = true; // å…¼å®¹å…¶ä»–æµè§ˆå™¨
            
            // è¿‡æ»¤æ–‡ä»¶ç±»å‹ï¼ˆè§£å‹/å‹ç¼©ä¸åŒï¼‰
            if (currentFunc === 'decompress') {
                fileInput.accept = '.bundle,.asset,.zlib,.gz';
            }
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selectedFiles = Array.from(e.target.files); // æ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶
                    inputType = 'folder'; // æ ‡è®°è¾“å…¥ç±»å‹ä¸ºæ–‡ä»¶å¤¹
                    // è·å–æ–‡ä»¶å¤¹åç§°ï¼ˆä»ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„webkitRelativePathè§£æï¼‰
                    const folderPath = selectedFiles[0].webkitRelativePath.split('/')[0];
                    inputPath = folderPath;
                    inputPathInput.value = `æ–‡ä»¶å¤¹: ${folderPath} (å…±${selectedFiles.length}ä¸ªæ–‡ä»¶)`;
                    log(`å·²é€‰æ‹©æ–‡ä»¶å¤¹: ${folderPath}ï¼ŒåŒ…å« ${selectedFiles.length} ä¸ªæ–‡ä»¶`);
                }
            });
            
            fileInput.click();
        }

        // æµè§ˆè¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šæ”¯æŒçœŸæ­£é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹ï¼‰
        async function browseOutputFolder() {
            try {
                if (isFileSystemSupported) {
                    // ç°ä»£æµè§ˆå™¨ï¼šä½¿ç”¨FileSystem Access APIé€‰æ‹©æ–‡ä»¶å¤¹
                    selectedDirHandle = await window.showDirectoryPicker({
                        mode: 'readwrite' // è¯»å†™æƒé™
                    });
                    
                    // æ˜¾ç¤ºæ–‡ä»¶å¤¹åç§°ï¼ˆå°½å¯èƒ½è·å–è·¯å¾„ï¼‰
                    const folderName = selectedDirHandle.name || 'è‡ªå®šä¹‰æ–‡ä»¶å¤¹';
                    outputPath = folderName;
                    outputPathInput.value = `ğŸ“ ${folderName}`;
                    log(`å·²é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹: ${folderName}ï¼ˆæ”¯æŒç›´æ¥å†™å…¥ï¼‰`);
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šæ—§æµè§ˆå™¨ä½¿ç”¨æç¤ºæ¡†+ä¸‹è½½æ–¹å¼
                    const folderName = prompt('è¯·è¾“å…¥è¾“å‡ºæ–‡ä»¶å¤¹åç§°ï¼ˆæ–‡ä»¶å°†ä¸‹è½½åˆ°æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•ï¼‰:', 'è¾“å‡ºæ–‡ä»¶');
                    if (folderName) {
                        outputPath = folderName;
                        outputPathInput.value = folderName;
                        log(`å·²è®¾ç½®è¾“å‡ºæ–‡ä»¶å¤¹åç§°: ${folderName}ï¼ˆæ–‡ä»¶å°†ä¸‹è½½åˆ°é»˜è®¤ä¸‹è½½ç›®å½•ï¼‰`);
                    }
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    log(`é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`);
                } else {
                    log('å·²å–æ¶ˆé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹');
                }
            }
        }

        // å•æ¬¡å¤„ç†ï¼ˆä»…å¤„ç†å•ä¸ªæ–‡ä»¶ï¼‰
        async function handleSingle() {
            // æ ¡éªŒï¼šå¿…é¡»é€‰äº†å•ä¸ªæ–‡ä»¶
            if (inputType !== 'file' || selectedFiles.length !== 1) {
                log('å•æ¬¡å¤„ç†è¯·å…ˆé€šè¿‡ã€Œæµè§ˆæ–‡ä»¶ã€é€‰æ‹©å•ä¸ªæ–‡ä»¶ï¼');
                return;
            }
            if (!outputPath || (isFileSystemSupported && !selectedDirHandle)) {
                log('è¯·å…ˆé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼');
                return;
            }

            const file = selectedFiles[0];
            log(`å¼€å§‹${currentFunc === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}: ${file.name}`);

            try {
                let result;
                if (currentFunc === 'decompress') {
                    result = await decompressFile(file);
                    await saveFile(result.data, file.name.replace(/\.(bundle|asset|zlib|gz)$/i, ''));
                } else {
                    const signature = unitySignatureInput.value.trim();
                    if (!signature) {
                        log('è¯·è¾“å…¥Unityç­¾å');
                        return;
                    }
                    result = await compressFile(file, signature);
                    await saveFile(result.data, file.name + '.bundle');
                }
                log(`${currentFunc === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}æˆåŠŸ: ${file.name}`);
            } catch (error) {
                log(`${currentFunc === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}å¤±è´¥: ${error.message}`);
            }
        }

        // æ‰¹é‡å¤„ç†ï¼ˆä»…å¤„ç†æ–‡ä»¶å¤¹å†…æ–‡ä»¶ï¼‰
        async function handleBatch() {
            // æ ¡éªŒï¼šå¿…é¡»é€‰äº†æ–‡ä»¶å¤¹
            if (inputType !== 'folder' || selectedFiles.length === 0) {
                log('æ‰¹é‡å¤„ç†è¯·å…ˆé€šè¿‡ã€Œæµè§ˆæ–‡ä»¶å¤¹ã€é€‰æ‹©æ–‡ä»¶å¤¹ï¼');
                return;
            }
            if (!outputPath || (isFileSystemSupported && !selectedDirHandle)) {
                log('è¯·å…ˆé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹ï¼');
                return;
            }

            log(`å¼€å§‹æ‰¹é‡${currentFunc === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}ï¼Œå…± ${selectedFiles.length} ä¸ªæ–‡ä»¶`);
            let successCount = 0;

            for (const file of selectedFiles) {
                // è·³è¿‡æ–‡ä»¶å¤¹å†…çš„å­æ–‡ä»¶å¤¹ï¼ˆåªå¤„ç†æ–‡ä»¶ï¼‰
                if (file.size === 0) continue;
                
                try {
                    let result;
                    let fileName;
                    if (currentFunc === 'decompress') {
                        result = await decompressFile(file);
                        // ä¿ç•™ç›¸å¯¹è·¯å¾„ï¼Œé¿å…é‡å
                        fileName = file.webkitRelativePath ? 
                            file.webkitRelativePath.replace(/\.(bundle|asset|zlib|gz)$/i, '') : 
                            file.name.replace(/\.(bundle|asset|zlib|gz)$/i, '');
                    } else {
                        const signature = unitySignatureInput.value.trim();
                        if (!signature) {
                            log('è¯·è¾“å…¥Unityç­¾å');
                            return;
                        }
                        result = await compressFile(file, signature);
                        fileName = file.webkitRelativePath ? 
                            `${file.webkitRelativePath}.bundle` : 
                            `${file.name}.bundle`;
                    }
                    // ä¿å­˜æ–‡ä»¶ï¼ˆæ”¯æŒå­è·¯å¾„ï¼‰
                    await saveFile(result.data, fileName, true);
                    successCount++;
                    log(`æˆåŠŸ${currentFunc === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}: ${file.webkitRelativePath || file.name}`);
                } catch (error) {
                    log(`å¤±è´¥${currentFunc === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}: ${file.webkitRelativePath || file.name} - ${error.message}`);
                }
            }

            log(`æ‰¹é‡${currentFunc === 'decompress' ? 'è§£å‹' : 'å‹ç¼©'}å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${selectedFiles.length - successCount} ä¸ª`);
        }

        // æ¸…é™¤æ‰€æœ‰è¾“å…¥
        function clearAll() {
            inputPathInput.value = '';
            outputPathInput.value = '';
            if (currentFunc === 'compress') {
                unitySignatureInput.value = 'subway_bundles';
            }
            selectedFiles = [];
            inputPath = '';
            outputPath = '';
            inputType = ''; // é‡ç½®è¾“å…¥ç±»å‹
            selectedDirHandle = null; // é‡ç½®æ–‡ä»¶å¤¹å¥æŸ„
            logText.value = '';
            log('å·²æ¸…é™¤æ‰€æœ‰è¾“å…¥å’Œæ—¥å¿—');
        }

        // æ—¥å¿—åŠŸèƒ½
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logText.value += `[${timestamp}] ${message}\n`;
            logText.scrollTop = logText.scrollHeight;
        }

        // ä¿å­˜æ–‡ä»¶ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šæ”¯æŒå†™å…¥åˆ°é€‰ä¸­çš„æ–‡ä»¶å¤¹ï¼‰
        async function saveFile(data, filename, isBatch = false) {
            try {
                if (isFileSystemSupported && selectedDirHandle) {
                    // ç°ä»£æµè§ˆå™¨ï¼šç›´æ¥å†™å…¥åˆ°é€‰ä¸­çš„æ–‡ä»¶å¤¹ï¼ˆæ”¯æŒå­æ–‡ä»¶å¤¹ï¼‰
                    const blob = new Blob([data], { type: 'application/octet-stream' });
                    const pathParts = filename.split('/');
                    let currentDir = selectedDirHandle;

                    // å¤„ç†å­æ–‡ä»¶å¤¹è·¯å¾„
                    if (pathParts.length > 1) {
                        for (let i = 0; i < pathParts.length - 1; i++) {
                            const dirName = pathParts[i];
                            try {
                                currentDir = await currentDir.getDirectoryHandle(dirName, { create: true });
                            } catch (e) {
                                log(`åˆ›å»ºå­æ–‡ä»¶å¤¹å¤±è´¥: ${dirName} - ${e.message}`);
                                throw e;
                            }
                        }
                        filename = pathParts[pathParts.length - 1];
                    }

                    // å†™å…¥æ–‡ä»¶
                    const fileHandle = await currentDir.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    
                    log(`æ–‡ä»¶å·²ä¿å­˜åˆ°è¾“å‡ºæ–‡ä»¶å¤¹: ${filename}`);
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šæ—§æµè§ˆå™¨ä½¿ç”¨ä¸‹è½½æ–¹å¼
                    const blob = new Blob([data], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = isBatch ? `${outputPath}_${filename}` : filename;
                    a.click();
                    
                    // é‡Šæ”¾URL
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    log(`æ–‡ä»¶å·²ä¸‹è½½: ${a.download}`);
                }
            } catch (error) {
                log(`ä¿å­˜æ–‡ä»¶å¤±è´¥: ${filename} - ${error.message}`);
                throw error;
            }
        }

        // ========== æ ¸å¿ƒï¼šè¯»å–Unityæ ¼å¼å­—ç¬¦ä¸²ï¼ˆ7-bitç¼–ç é•¿åº¦å‰ç¼€ï¼‰ ==========
        function readUnityString(view, offset) {
            let length = 0;
            let shift = 0;
            let currentOffset = offset;

            while (true) {
                const b = view.getUint8(currentOffset);
                currentOffset++;
                
                length |= (b & 0x7F) << shift;
                
                if ((b & 0x80) === 0) break;
                shift += 7;
                if (shift > 35) throw new Error('æ— æ•ˆçš„Unityå­—ç¬¦ä¸²æ ¼å¼');
            }

            const strBytes = new Uint8Array(view.buffer, currentOffset, length);
            currentOffset += length;
            const decoder = new TextDecoder('utf-8');
            const str = decoder.decode(strBytes);
            
            return { str, newOffset: currentOffset };
        }

        // ========== æ ¸å¿ƒï¼šå†™å…¥Unityæ ¼å¼å­—ç¬¦ä¸² ==========
        function writeUnityString(str) {
            const encoder = new TextEncoder('utf-8');
            const strBytes = encoder.encode(str);
            const length = strBytes.length;
            
            const lengthBytes = [];
            let len = length;
            while (len > 0x7F) {
                lengthBytes.push((len & 0x7F) | 0x80);
                len >>= 7;
            }
            lengthBytes.push(len);
            
            return new Uint8Array([...lengthBytes, ...strBytes]);
        }

        // ========== æ ¸å¿ƒï¼šUnityæ ¼å¼Zlibè§£å‹ ==========
        function decompressFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const view = new DataView(arrayBuffer);
                        let offset = 0;

                        // 1. è¯»å–Unityç­¾åå­—ç¬¦ä¸²
                        const { str: signature, newOffset } = readUnityString(view, offset);
                        offset = newOffset;

                        // 2. è¯»å–åŸå§‹å¤§å°ï¼ˆ4å­—èŠ‚å°ç«¯æ•´æ•°ï¼‰
                        const originalSize = view.getInt32(offset, true);
                        offset += 4;

                        // 3. è¯»å–å‹ç¼©æ•°æ®å¹¶è§£å‹
                        const compressedData = new Uint8Array(arrayBuffer, offset);
                        const decompressed = pako.inflate(compressedData, { windowBits: -15 });

                        // éªŒè¯å¤§å°
                        if (decompressed.length !== originalSize) {
                            throw new Error(`è§£å‹å¤§å°ä¸åŒ¹é…ï¼šå®é™…${decompressed.length}ï¼Œé¢„æœŸ${originalSize}`);
                        }

                        resolve({
                            filename: file.name,
                            data: decompressed,
                            signature: signature
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–é”™è¯¯'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ========== æ ¸å¿ƒï¼šUnityæ ¼å¼Zlibå‹ç¼© ==========
        function compressFile(file, signature) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const data = new Uint8Array(arrayBuffer);
                        const originalSize = data.length;

                        // 1. å‹ç¼©æ•°æ®
                        const compressedData = pako.deflate(data, { level: 9, windowBits: -15 });

                        // 2. ç”ŸæˆUnityç­¾åå­—èŠ‚
                        const signatureBytes = writeUnityString(signature);

                        // 3. ç”ŸæˆåŸå§‹å¤§å°å­—èŠ‚ï¼ˆ4å­—èŠ‚å°ç«¯ï¼‰
                        const sizeBuffer = new ArrayBuffer(4);
                        const sizeView = new DataView(sizeBuffer);
                        sizeView.setInt32(0, originalSize, true);
                        const sizeBytes = new Uint8Array(sizeBuffer);

                        // 4. åˆå¹¶æ‰€æœ‰æ•°æ®
                        const resultData = new Uint8Array([
                            ...signatureBytes,
                            ...sizeBytes,
                            ...compressedData
                        ]);

                        resolve({
                            filename: file.name,
                            data: resultData
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–é”™è¯¯'));
                reader.readAsArrayBuffer(file);
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>
